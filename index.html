<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trialogue</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #4a90e2 0%, #5ba3f5 100%);
        min-height: 100vh;
      }

      /* Landing Page */
      .landing-page {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 40px;
        text-align: center;
        color: white;
      }

      .landing-page.hidden {
        display: none;
      }

      .landing-title {
        font-size: 82px;
        font-weight: 700;
        margin-bottom: 30px;
        letter-spacing: -2px;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .landing-description {
        font-size: 22px;
        line-height: 1.7;
        max-width: 650px;
        margin-bottom: 50px;
        opacity: 0.95;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .start-button {
        padding: 18px 55px;
        font-size: 20px;
        font-weight: 600;
        background: white;
        color: #4a90e2;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
      }

      .start-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 35px rgba(0, 0, 0, 0.35);
      }

      /* Chat Page */
      .chat-page {
        display: none;
        max-width: 1000px;
        margin: 0 auto;
        height: 100vh;
        flex-direction: column;
        padding: 30px;
      }

      .chat-page.active {
        display: flex;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .header {
        padding: 25px 30px;
        background: white;
        border-bottom: 2px solid #f0f0f0;
      }

      .header h1 {
        font-size: 28px;
        background: linear-gradient(135deg, #4a90e2 0%, #5ba3f5 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
      }

      .patient-select {
        padding: 20px 30px;
        background: #fafafa;
        border-bottom: 2px solid #f0f0f0;
      }

      .patient-select select {
        width: 100%;
        padding: 14px 18px;
        font-size: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: white;
        color: #333;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
      }

      .patient-select select:hover {
        border-color: #4a90e2;
      }

      .patient-select select:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 16px;
        padding: 16px 20px;
        border-radius: 16px;
        max-width: 75%;
        white-space: pre-wrap;
        line-height: 1.6;
        clear: both;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message strong,
      .message b {
        font-weight: 600;
      }

      .message.agent {
        background: white;
        margin-right: auto;
        color: #2d3748;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
      }

      .message.agent strong {
        color: #4a90e2;
      }

      .message.patient {
        background: linear-gradient(135deg, #4a90e2 0%, #5ba3f5 100%);
        color: white;
        margin-left: auto;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
      }

      .message.system {
        background: rgba(74, 144, 226, 0.15);
        color: #3b7bbf;
        margin: 0 auto 16px auto;
        text-align: center;
        font-weight: 600;
        max-width: 60%;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2);
        border: 1px solid rgba(74, 144, 226, 0.3);
      }

      .input-area {
        padding: 25px 30px;
        background: white;
        border-top: 2px solid #f0f0f0;
        display: flex;
        gap: 12px;
      }

      .input-area input {
        flex: 1;
        padding: 14px 20px;
        font-size: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        background: #fafafa;
        transition: all 0.2s;
      }

      .input-area input:focus {
        outline: none;
        border-color: #4a90e2;
        background: white;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
      }

      .input-area button {
        padding: 14px 32px;
        background: linear-gradient(135deg, #4a90e2 0%, #5ba3f5 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
      }

      .input-area button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
      }

      .input-area button:active {
        transform: translateY(0);
      }

      .patient-select.hidden {
        display: none;
      }

      .typing-indicator {
        padding: 12px 20px;
        border-radius: 16px;
        background: white;
        margin-bottom: 16px;
        min-width: 65px;
        display: inline-block;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
      }

      .typing-indicator.right {
        float: right;
        clear: both;
        background: linear-gradient(135deg, #4a90e2 0%, #5ba3f5 100%);
      }

      .typing-indicator.right span {
        background: white;
      }

      .typing-indicator.left {
        float: left;
        clear: both;
      }

      .typing-indicator span {
        height: 9px;
        width: 9px;
        background: linear-gradient(135deg, #4a90e2 0%, #5ba3f5 100%);
        border-radius: 50%;
        display: inline-block;
        margin: 0 4px;
        animation: typing 1.2s infinite ease-in-out;
        vertical-align: middle;
      }

      .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.15s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes typing {
        0%,
        100% {
          transform: translateY(0);
          opacity: 0.3;
        }
        50% {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Scrollbar */
      .messages::-webkit-scrollbar {
        width: 8px;
      }

      .messages::-webkit-scrollbar-track {
        background: #f0f0f0;
      }

      .messages::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #4a90e2 0%, #5ba3f5 100%);
        border-radius: 4px;
      }

      .messages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5ba3f5 0%, #4a90e2 100%);
      }
    </style>
  </head>
  <body>
    <!-- Landing Page -->
    <div class="landing-page" id="landing-page">
      <h1 class="landing-title">Trialogue</h1>
      <p class="landing-description">
        Discover clinical trials that match your unique health profile.
        Trialogue uses AI to help you navigate the complex world of clinical
        research, providing personalized trial recommendations and answering
        your questions with empathy and clarity.
      </p>
      <button class="start-button" onclick="showChatPage()">
        Start Trialogue
      </button>
    </div>

    <!-- Chat Page -->
    <div class="chat-page" id="chat-page">
      <div class="chat-container">
        <div class="header">
          <h1>Trialogue</h1>
        </div>

        <div class="patient-select">
          <select id="patient-select" onchange="startConversation()">
            <option value="">Select a patient...</option>
            <option value="sigir-20141">Patient 1 - Alex Rivera (20141)</option>
            <option value="sigir-20142">Patient 2 - Jordan Chen (20142)</option>
            <option value="sigir-20148">
              Patient 3 - Taylor Patel (20143)
            </option>
            <option value="sigir-201417">
              Patient 4 - Casey Johnson (20144)
            </option>
            <option value="sigir-201419">Patient 5 - Morgan Kim (20145)</option>
            <option value="sigir-201513">
              Patient 6 - Riley Thompson (20146)
            </option>
            <option value="sigir-201520">
              Patient 7 - Avery Washington (20147)
            </option>
            <option value="sigir-201524">
              Patient 8 - Quinn Martinez (20148)
            </option>
          </select>
        </div>

        <div class="messages" id="messages"></div>

        <div class="input-area" id="input-area">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message..."
            onkeypress="handleKeyPress(event)"
          />
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>

    <script>
      let currentPatient = null;
      let conversationState = "select_patient";
      let allTrials = [];
      let currentTrialIndex = 0;
      let preferenceQA = []; // Track Q&A for preference gathering
      let currentQuestionNumber = 1; // Track which question we're on

      function isQuestion(text) {
        // Detect if user is asking a question rather than just confirming/responding
        const lowerText = text.toLowerCase().trim();

        // Question indicators
        const questionWords = [
          "what",
          "why",
          "how",
          "when",
          "where",
          "who",
          "which",
          "can you",
          "could you",
          "would",
          "is",
          "are",
          "do",
          "does",
          "tell me",
          "explain",
          "describe",
        ];
        const hasQuestionMark = text.includes("?");
        const startsWithQuestion = questionWords.some((word) =>
          lowerText.startsWith(word)
        );

        // Short confirmations are not questions
        const shortResponses = [
          "yes",
          "no",
          "ok",
          "okay",
          "sure",
          "nope",
          "yep",
          "yeah",
          "thanks",
          "thank you",
        ];
        const isShortResponse =
          lowerText.split(" ").length <= 3 &&
          shortResponses.some((resp) => lowerText.includes(resp));

        if (isShortResponse) {
          return false;
        }

        return hasQuestionMark || startsWithQuestion;
      }

      function getConversationContext() {
        // Build context object to send with chat requests
        return {
          state: conversationState,
          current_trial_index: currentTrialIndex,
          all_trials: allTrials,
          eligible_trials: window.eligibleTrialsForNarrowing || [],
          recommended_trial: window.recommendedTrial || null,
          current_patient: currentPatient,
        };
      }

      function showChatPage() {
        document.getElementById("landing-page").classList.add("hidden");
        document.getElementById("chat-page").classList.add("active");
      }

      function formatText(text) {
        text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        text = text.replace(/\n/g, "<br>");
        return text;
      }

      function addMessage(text, type) {
        const messages = document.getElementById("messages");
        const div = document.createElement("div");
        div.className = `message ${type}`;
        div.innerHTML = formatText(text);
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function showTypingIndicator(position = "left") {
        const messages = document.getElementById("messages");
        const div = document.createElement("div");
        div.id = "typing-indicator";
        div.className = `typing-indicator ${position}`;
        div.innerHTML = "<span></span><span></span><span></span>";
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function hideTypingIndicator() {
        const indicator = document.getElementById("typing-indicator");
        if (indicator) {
          indicator.remove();
        }
      }

      async function startConversation() {
        const select = document.getElementById("patient-select");
        currentPatient = select.value;

        if (!currentPatient) return;

        document
          .getElementById("patient-select")
          .parentElement.classList.add("hidden");
        document.getElementById("messages").innerHTML = "";
        conversationState = "loading";

        const greetingData = await fetch("/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ patient_id: currentPatient }),
        }).then((r) => r.json());

        // Agent greeting to user
        addMessage(greetingData.agent_greeting, "agent");

        // Fetch convo flow
        await delay(500);
        showTypingIndicator("right");

        const introData = await fetch("/generate-intro", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ patient_id: currentPatient }),
        }).then((r) => r.json());

        // Patient's brief intro
        hideTypingIndicator();
        addMessage(introData.patient_intro, "patient");

        // Agent asks for more info
        await delay(2500);
        showTypingIndicator("left");
        await delay(1500);
        hideTypingIndicator();
        addMessage(introData.agent_ask, "agent");

        // Patient provides complete info
        await delay(2500);
        showTypingIndicator("right");
        await delay(1000);
        hideTypingIndicator();
        addMessage(introData.patient_complete, "patient");

        // Agent confirms understanding
        await delay(2500);
        showTypingIndicator("left");
        await delay(1500);
        hideTypingIndicator();
        addMessage(introData.confirmation_prompt, "agent");

        conversationState = "confirming";
      }

      async function handleUserInput(text) {
        addMessage(text, "patient");

        if (conversationState === "confirming") {
          if (
            text.toLowerCase().includes("yes") ||
            text.toLowerCase().includes("y")
          ) {
            conversationState = "loading";
            showTypingIndicator("left");
            await delay(2000);
            hideTypingIndicator();
            addMessage(
              "Perfect! I have information on 10 clinical trials that we can review together. I'll go through each one with you and explain whether you're eligible and why. This will help us find the best option for your situation.",
              "agent"
            );

            await delay(2500);
            addMessage("Analyzing trials...", "system");

            const response = await fetch("/analyze", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ patient_id: currentPatient }),
            }).then((r) => r.json());

            allTrials = response.trials;
            currentTrialIndex = 0;
            conversationState = "reviewing_trials";

            await delay(2500);
            showCurrentTrial();
          } else {
            showTypingIndicator("left");
            await delay(2000);
            hideTypingIndicator();
            addMessage(
              "No worries at all! Let's clarify what needs to be corrected. What should I update?",
              "agent"
            );
            conversationState = "interactive";
          }
        } else if (conversationState === "gathering_preferences") {
          // User has answered current preference question
          // Store Q&A pair
          preferenceQA.push({
            question: window.currentPreferenceQuestion,
            answer: text,
          });

          currentQuestionNumber++;

          // Check if we should ask another question or finalize
          if (currentQuestionNumber <= 3) {
            // Ask next question
            conversationState = "loading";
            showTypingIndicator("left");

            const nextQuestionResponse = await fetch(
              "/get-preference-questions",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  eligible_trials: window.eligibleTrialsForNarrowing,
                  question_number: currentQuestionNumber,
                  previous_qa: preferenceQA,
                }),
              }
            ).then((r) => r.json());

            hideTypingIndicator();

            if (nextQuestionResponse.question) {
              await delay(500);
              addMessage(nextQuestionResponse.question, "agent");
              window.currentPreferenceQuestion = nextQuestionResponse.question;
              conversationState = "gathering_preferences";
            } else {
              // No more questions, proceed to narrow down trials
              await narrowDownTrials();
            }
          } else {
            // Done with questions, narrow down trials
            await narrowDownTrials();
          }
        } else if (conversationState === "interactive") {
          conversationState = "loading";

          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              context: getConversationContext(),
            }),
          }).then((r) => r.json());

          showTypingIndicator("left");
          await delay(2000);
          hideTypingIndicator();
          addMessage(response.response, "agent");
          conversationState = "interactive";
        }
      }

      async function narrowDownTrials() {
        // Narrow down trials based on all collected Q&A
        conversationState = "loading";

        await delay(1000);
        addMessage(
          "Thank you for sharing your preferences! Let me find the best trial match for you...",
          "system"
        );

        showTypingIndicator("left");

        const narrowResponse = await fetch("/narrow-trials", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            eligible_trials: window.eligibleTrialsForNarrowing,
            preference_qa: preferenceQA,
          }),
        }).then((r) => r.json());

        hideTypingIndicator();
        await delay(1000);
        addMessage(narrowResponse.message, "agent");

        // Check if conversation should end
        if (narrowResponse.conversation_ended) {
          conversationState = "done";

          // Disable input
          const input = document.getElementById("message-input");
          input.disabled = true;
          input.placeholder =
            "Conversation ended. Refresh to start a new conversation.";

          // Also disable send button
          const sendButton = document.querySelector(".input-area button");
          if (sendButton) {
            sendButton.disabled = true;
            sendButton.style.opacity = "0.5";
            sendButton.style.cursor = "not-allowed";
          }
        } else {
          // Store recommended trial for context (fallback if needed)
          window.recommendedTrial = narrowResponse.recommended_trial;
          conversationState = "post_recommendation";
        }
      }

      function showCurrentTrial() {
        const trial = allTrials[currentTrialIndex];
        const status = trial.eligible ? "✓ ELIGIBLE" : "✗ NOT ELIGIBLE";

        const trialNum = currentTrialIndex + 1;
        const totalTrials = allTrials.length;

        // Format diseases list
        const diseases =
          trial.diseases && trial.diseases.length > 0
            ? trial.diseases.join(", ")
            : "Not specified";

        // Format phase - "Not listed" if empty or N/A
        const phase =
          trial.phase && trial.phase !== "N/A" && trial.phase.trim() !== ""
            ? trial.phase
            : "Not listed";

        const html = `**TRIAL ${trialNum} of ${totalTrials}**

**${trial.title}**

**Phase:** ${phase}

**Focus Areas:** ${diseases}

**Brief Summary:**
${trial.brief_summary}

**Status: ${status}**

${trial.explanation}

${
  trialNum < totalTrials
    ? "**Press Enter** to continue to the next trial..."
    : "**Press Enter** to view summary..."
}`;

        addMessage(html, "agent");
      }

      async function showSummary() {
        conversationState = "loading";
        const eligible = allTrials.filter((t) => t.eligible);

        await delay(2000);

        if (eligible.length === 0) {
          addMessage(
            "I understand this might be disappointing, but based on our review, you don't currently meet the eligibility criteria for any of these 10 trials.\n\nThis doesn't mean there aren't other options out there for you. Here's what I recommend:\n\n• Talk with your healthcare provider about other clinical trial opportunities\n• Check ClinicalTrials.gov regularly for new studies\n• Remember that eligibility can change as your situation evolves or new trials open\n\nYour health journey is unique, and the right trial may still be out there.",
            "agent"
          );
          conversationState = "done";
        } else if (eligible.length === 1) {
          const trial = eligible[0];
          const title = trial.title;
          const trialId = trial.trial.trial_info.trial_id || "N/A";

          addMessage(
            `Good news! You're eligible for one clinical trial:\n\n**${title}**\n\nTrial ID: ${trialId}\n\nThis is an excellent match for you based on your medical profile! To learn more about this trial and how to enroll, visit **ClinicalTrials.gov** and search for trial ID: **${trialId}**\n\nYou can also visit this direct link: https://clinicaltrials.gov/study/${trialId}\n\nFeel free to ask me any questions about this trial!`,
            "agent"
          );
          conversationState = "interactive";
        } else {
          // Multiple eligible trials - start iterative preference questions
          let msg = `Great news! You're eligible for ${eligible.length} clinical trials:\n\n`;
          eligible.forEach((t, i) => {
            const title = t.title;
            const trialId = t.trial.trial_info.trial_id || "N/A";
            msg += `${i + 1}. ${title} (ID: ${trialId})\n`;
          });
          msg +=
            "\nTo help you find the best trial for your needs, I'd like to ask you a few questions about your preferences. Let's take this one step at a time.";

          addMessage(msg, "agent");

          // Store eligible trials and reset Q&A
          window.eligibleTrialsForNarrowing = eligible;
          preferenceQA = [];
          currentQuestionNumber = 1;

          // Get first question
          await delay(2000);
          showTypingIndicator("left");

          const prefResponse = await fetch("/get-preference-questions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              eligible_trials: eligible,
              question_number: 1,
              previous_qa: [],
            }),
          }).then((r) => r.json());

          hideTypingIndicator();

          if (prefResponse.question) {
            addMessage(prefResponse.question, "agent");
            conversationState = "gathering_preferences";
            window.currentPreferenceQuestion = prefResponse.question;
          } else {
            addMessage(
              "Feel free to ask me questions about any of these trials!",
              "agent"
            );
            conversationState = "interactive";
          }
        }
      }

      async function sendMessage() {
        const input = document.getElementById("message-input");
        const text = input.value.trim();

        if (!text && conversationState !== "reviewing_trials") return;

        input.value = "";

        if (conversationState === "loading") return;

        // Check if user is asking a question during trial review
        if (
          conversationState === "reviewing_trials" &&
          text &&
          text !== "continue" &&
          isQuestion(text)
        ) {
          // User asked a question, answer it, then resume flow
          addMessage(text, "patient");
          conversationState = "loading";
          showTypingIndicator("left");

          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              context: getConversationContext(),
            }),
          }).then((r) => r.json());

          hideTypingIndicator();
          await delay(500);
          addMessage(response.response, "agent");

          // Resume trial review state
          await delay(2000);
          conversationState = "reviewing_trials";
          addMessage("Press Enter to continue to the next trial...", "system");
          return;
        }

        if (
          conversationState === "reviewing_trials" &&
          (!text || text === "continue")
        ) {
          currentTrialIndex++;

          if (currentTrialIndex < allTrials.length) {
            showCurrentTrial();
          } else {
            await showSummary();
          }
          return;
        }

        await handleUserInput(text);
      }

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          if (conversationState === "reviewing_trials") {
            const input = document.getElementById("message-input");
            input.value = "continue";
            sendMessage();
          } else {
            sendMessage();
          }
        }
      }

      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      window.onload = function () {
        document.getElementById("message-input").focus();
      };
    </script>
  </body>
</html>
